angular.module("ez.dropdown",[]).constant("EzDropdownConfig",{mobileThreshold:768,mobileEnabled:!0,clickInside:!1,absolute:!1,getNameFn:function(a){return a.name},drilldownEnabled:!0,mobileDrilldownEnabled:!0,backdropEnabled:!0,dropdownPointer:!0}).controller("EzDropdownCtrl",["EzDropdownConfig","$scope","$document","$parse","$compile","$timeout","$templateCache","$location",function(a,b,c,d,e,f,g,h){function i(){b.options.mobileEnabled&&window.innerWidth<b.options.mobileThreshold&&(b.menu.isMobile=!0),m?b.menu.isMobile?b.menu.isDrilldown=b.options.mobileDrilldownEnabled:b.menu.isDrilldown=b.options.drilldownEnabled:b.menu.isDrilldown=!1,b.menu.isDrilldown?b.menu.clickInside=!0:b.menu.clickInside=b.options.clickInside}function j(){if(b.menu.isMobile){var a=20;if(!b.menu.isDrilldown){var c=o.height()-window.innerHeight;0>c&&(a=-c/2)}o.css({width:window.innerWidth-40,maxHeight:window.innerHeight-20,top:a})}else o.css({width:"auto",top:""})}function k(a){a&&"keyup"===a.type?27===a.which&&(b.isOpen=!1,b.$apply()):a&&b.menu.clickInside&&p&&p.contains(a.target)?setTimeout(function(){c.one("click",k)}):(b.isOpen=!1,b.$apply())}function l(){b.menu.openItem=null,b.menu.activeItem?b.menu.activeItemId=b.menu.activeItem.id:b.menu.activeItem=null;for(var a=0,c=b.menu.items.length;c>a;a++)if(b.menu.items[a].hasOwnProperty("conditional")?"boolean"!=typeof b.menu.items[a].conditional&&(b.menu.items[a].conditional=b.$parent.$eval(b.menu.items[a].conditional)):b.menu.items[a].conditional=!0,b.menu.items[a].id===b.menu.activeItemId&&(b.menu.activeItem=b.menu.items[a],b.menu.activeItem.active=!0),b.menu.items[a].items)for(var d=0,e=b.menu.items[a].items.length;e>d;d++)b.menu.items[a].items[d].parent=b.menu.items[a],b.menu.items[a].items[d].hasOwnProperty("conditional")?"boolean"!=typeof b.menu.items[a].items[d].conditional&&(b.menu.items[a].items[d].conditional=b.$parent.$eval(b.menu.items[a].items[d].conditional)):b.menu.items[a].items[d].conditional=!0,b.menu.items[a].items[d].id===b.menu.activeItemId&&(b.menu.activeItem=b.menu.items[a].items[d],b.menu.openItem=b.menu.activeItem.parent,b.menu.activeItem.active=!0,b.menu.openItem.open=!0)}var m,n,o,p,q,r=!1,s=this;this.compileDropdownMenu=function(a){r=!0,o||(o=angular.element(g.get("ez-dropdown-menu.html")),p=o[0]),e(o.clone())(m?b:b.$parent,function(a){o=a,p=a[0],b.options.absolute?(n=angular.element('<span class="dropdown dropdown-absolute"></span>'),n.append(o),$("body").append(n)):n.append(o)})},this.show=function(){if(r||this.compileDropdownMenu(),i(),$("body").addClass("modal-open"),b.menu.isMobile?($("body").addClass("mobile-modal-open"),setTimeout(function(){j()}),b.options.backdropEnabled&&(q=angular.element('<div class="modal-backdrop fade in"></div>'),$("body").append(q)),n.addClass("dropdown-mobile")):j(),b.options.absolute&&b.clickEvent){var a,d=b.clickEvent.clientY+$(document).scrollTop(),e=o.width();a=b.clickEvent.clientX+e>window.innerWidth?b.clickEvent.clientX-e:b.clickEvent.clientX,n.css({top:d+"px",left:a+"px"}),b.clickEvent=null}n.addClass("open"),"function"==typeof b.onToggle&&b.onToggle(!0),setTimeout(function(){c.one("click",k),c.one("keyup",k)})},this.hide=function(){n.removeClass("open"),b.menu.isMobile&&(n.removeClass("dropdown-mobile"),o.css({top:"auto",width:"auto"})),"function"==typeof b.onToggle&&b.onToggle(!1),q&&q.remove(),$("body").removeClass("modal-open mobile-modal-open"),c.off("click",k)},this.toggle=function(a){b.clickEvent=a,b.isOpen=!b.isOpen},this.resolveOptions=function(c){b.options=angular.extend({},a,b.ezConfig);for(var e in a)c.hasOwnProperty(e)&&("boolean"==typeof a[e]||"function"==typeof a[e]?b.options[e]=d(c[e])(b.$parent):b.options[e]=c[e])},this.init=function(a,c){n=a,c?(o=c,p=c[0],b.menu={}):m=!0,b.toggleFn=s.toggle,i(),m&&(b.menu.activeItemId||b.menu.activeItem)&&l()},b.select=function(a,c){a!==b.menu.activeItem&&(c?(a.active=!a.active,a.active?(b.menu.activeItem&&(b.menu.activeItem.active=!1),b.menu.activeItem=a):delete b.menu.activeItem):b.menu.isDrilldown&&a.items?(a.open=!a.open,a.open?(b.menu.openItem&&(b.menu.openItem.open=!1),b.menu.openItem=a):delete b.menu.openItem):(a.active=!a.active,a.active?(b.menu.activeItem&&(b.menu.activeItem.active=!1),b.menu.activeItem=a):delete b.menu.activeItem),a.active&&a.href&&f(function(){b.isOpen=!1,-1!==a.href.indexOf("#")?h.path(a.href.replace("#","")):window.location.href=a.href},400),"function"==typeof b.onSelect&&b.onSelect(b.menu.activeItem,b.menu.openItem))},b.$watch("menu.activeItemId",function(a,b){a!==b&&l()}),b.$watch("isOpen",function(a,b){a!==b&&(a?s.show():s.hide())}),b.$on("$destroy",function(){q&&q.remove(),b.options.absolute&&n.remove(),n=o=p=q=null})}]).directive("dropdown",["EzDropdownConfig",function(a){return{restrict:"EA",controller:"EzDropdownCtrl",scope:{menu:"=?",isOpen:"=?",clickEvent:"=?",onToggle:"=?",onSelect:"=?",toggleFn:"=?",ezConfig:"=?"},compile:function(a,b){a.addClass("dropdown");var c;return b.hasOwnProperty("menu")||(c=a.children().last().remove().addClass("dropdown-menu")),function(a,b,d,e){a._scope=a.$parent,e.resolveOptions(d),e.init(b,c)}}}}]).directive("dropdownToggle",[function(){return{restrict:"A",require:"^dropdown",link:function(a,b,c,d){b.addClass("dropdown-toggle"),b.on("click",function(b){d.toggle(b),a.$apply()})}}}]);